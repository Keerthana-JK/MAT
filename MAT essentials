using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Net;
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media.Imaging;
using EmployeeDatabaseApp.Commands;
using EmployeeDatabaseApp.Models;

namespace EmployeeDatabaseApp.ViewModels
{
	public delegate void DWindowClose();
	public class EmployeeViewModel : IDataErrorInfo, INotifyPropertyChanged
	{
		public DWindowClose AddEmployeeDialogClose;
		public DWindowClose EditEmployeeDialogClose;

		private Employee _newEmployee;

		private string _id;
		private string _name;
		private string _email;
		private string _designation;
		private string _address;
		private string _photoPath;
		private string _phoneNumber;

		// Dictionary to hold Validation errors
		private readonly Dictionary<string, string> _errors = new Dictionary<string, string>();

		public string Id
		{
			get { return _id; }
			set
			{
				if (_id != value)
				{
					_id = value;
					ValidateProperty(nameof(Id));
					OnPropertyChanged(nameof(Id));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}
		public string Name
		{
			get { return _name; }
			set
			{
				if (_name != value)
				{
					_name = value;
					ValidateProperty(nameof(Name));
					OnPropertyChanged(nameof(Name));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}
		public string Email
		{
			get { return _email; }
			set
			{
				if (_email != value)
				{
					_email = value;
					ValidateProperty(nameof(Email));
					OnPropertyChanged(nameof(Email));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}

		public string Designation
		{
			get { return _designation; }
			set
			{
				if (_designation != value)
				{
					_designation = value;
					ValidateProperty(nameof(Designation));
					OnPropertyChanged(nameof(Designation));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}
		public string Address
		{
			get { return _address; }
			set
			{
				_address = value;
				OnPropertyChanged("Address");
			}
		}
		public string PhotoPath
		{
			get { return _photoPath; }
			set
			{
				_photoPath = value;
				OnPropertyChanged("PhotoPath");
			}
		}
		public string PhoneNumber
		{
			get { return _phoneNumber; }
			set
			{
				_phoneNumber = value;
				ValidateProperty(nameof(PhoneNumber));
				OnPropertyChanged("PhoneNumber");
			}
		}
		public Employee NewEmployee
		{
			get => _newEmployee;
			set { _newEmployee = value; OnPropertyChanged(nameof(NewEmployee)); }
		}
		private Employee _selectedEmployee;
		public Employee SelectedEmployee
		{
			get { return _selectedEmployee; }
			set
			{
				_selectedEmployee = value;
				OnPropertyChanged(nameof(SelectedEmployee));
			}
		}

		private ObservableCollection<Employee> _employees = null;
		public ObservableCollection<Employee> Employees
		{
			get => _employees;
			set { _employees = value; OnPropertyChanged(nameof(Employees)); }
		}

		public ICommand CreateCommand { get; }
		public ICommand UpdateCommand { get; }
		public ICommand DeleteCommand { get; }

		public EmployeeViewModel()
		{
			Employees=new ObservableCollection<Employee>();

			// Initialise with a new Employee object
			SelectedEmployee = new Employee();

			this.NewEmployee = new Employee { Id="1", Name="Keerthana", Email="kj@gmail.com", 
				Designation="Software Developer", Address="Ernakulam", PhoneNumber="1234567890"};
			this.Employees = new ObservableCollection<Employee>
			{
				new Employee{Id="1", Name="Keerthana", Email="kj@gmail.com",
				Designation="Software Developer", Address="Ernakulam", PhoneNumber="1234567890"},
			};
			CreateCommand = new RelayCommand(Create);
			//TODO*************************************
			//UpdateCommand = new RelayCommand(Update);
			//DeleteCommand = new RelayCommand(Delete);
		}

		public void Create()
		{
			string id = "1";
			if (Employees.Count > 0)
			{
				id = Employees[Employees.Count - 1].Id + 1;
			}
			Employee newEmployee = new Employee
			{
				Id = id,
				Name = NewEmployee.Name,
				Email = NewEmployee.Email,
				PhoneNumber = NewEmployee.PhoneNumber,
				Address = NewEmployee.Address,
				Designation = NewEmployee.Designation,
				ProfileImage = NewEmployee.ProfileImage,
				PhotoPath = NewEmployee.PhotoPath,
			};
			var result = MessageBox.Show(messageBoxText: "Are you sure to create?",
					caption: "Confirm",
					button: MessageBoxButton.YesNo,
					icon: MessageBoxImage.Question);
			if (result != MessageBoxResult.Yes)
			{
				return;
			}
			Employees.Add(newEmployee);
			this.NewEmployee = new Employee
			{
				Id = "0",
				Name = " ",
				Email = " ",
				Designation = " ",
				Address = " ",
				PhoneNumber = " "
			};
			result = MessageBox.Show(messageBoxText: "Created Successfully",
					caption: "Alert",
					button: MessageBoxButton.OK,
					icon: MessageBoxImage.Information);
			if (AddEmployeeDialogClose != null)
			{
				AddEmployeeDialogClose();
			}

		}
		public void AddEmployee()
		{
			Employees.Add(SelectedEmployee);
			// Reset after adding
			SelectedEmployee = new Employee();
			// Notify UI to refresh the form
			OnPropertyChanged(nameof(SelectedEmployee));
		}

		// Profile Image
		private BitmapImage _profileImage;
		public BitmapImage ProfileImage
		{
			get
			{
				return _profileImage;
			}
			set
			{
				_profileImage = value;
				OnPropertyChanged("ProfileImage");
			}
		}

		// Property to control Add button
		// Enabled if no error exists
		public bool IsButtonEnabled => !_errors.Any();

		// Centralized validation method
		private void ValidateProperty(string propertyName)
		{
			string error = string.Empty;
			switch (propertyName)
			{
				case nameof(Id):
					error = string.IsNullOrEmpty(Id) ? "ID is required" : null;
					break;
				case nameof(Name):
					error = string.IsNullOrEmpty(Name) ? "Name is required" : null;
					break;
				case nameof(Email):
					if (string.IsNullOrEmpty(Email))
					{
						error = "Email is required";
					}
					else if (!IsValidEmail(Email))
					{
						error = "Invalid email format";
					}
					break;
				case nameof(Designation):
					error = string.IsNullOrEmpty(Designation) ? "Designation is required" : null;
					break;
				case nameof(PhoneNumber):
					if (string.IsNullOrEmpty(PhoneNumber))
					{
						error = "Phone Number is required";
					}
					else if (!IsValidPhoneNumber(PhoneNumber))
					{
						error = "Phone Number must be 10 digits ";
					}
					break;
			}

			if (error != null)
			{
				_errors[propertyName] = error;
			}
			else
			{
				_errors.Remove(propertyName);
			}

			// Notify UI of error changes
			OnPropertyChanged(nameof(Error));
		}

		// Method to validate email format
		private bool IsValidEmail(string email)
		{
			string emailPattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
			return Regex.IsMatch(email, emailPattern);
		}

		// Method to validate phone number format
		private bool IsValidPhoneNumber(string phoneNumber)
		{
			string phonePattern = @"^\d{10}$";
			return Regex.IsMatch(phoneNumber, phonePattern);
		}

		public string Error => _errors.Any() ? "Please fix the errors" : null;



		public string this[string columnName] => _errors.ContainsKey(columnName) ? _errors[columnName] : null;

		// Property changed notification
		public event PropertyChangedEventHandler PropertyChanged;
		protected void OnPropertyChanged(string propertyName)
		{
			PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
		}

		// Method to load the image (after file selection)
		public void LoadImage(string imagePath)
		{
			ProfileImage = new BitmapImage(new Uri(imagePath));
		}
	}
}



<Window x:Class="EmployeeDatabaseApp.Dialogs.AddEmployeeDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:EmployeeDatabaseApp.Dialogs" xmlns:viewmodels="clr-namespace:EmployeeDatabaseApp.ViewModels" xmlns:models="clr-namespace:EmployeeDatabaseApp.Models" d:DataContext="{d:DesignInstance Type=viewmodels:EmployeeViewModel}"
		mc:Ignorable="d"
        Title="Add Employee" Height="450" Width="800" WindowStartupLocation="CenterScreen" Closing="Window_Closing">
	<Grid>
		<TextBlock x:Name="lblAddEmployee" Height="57" Margin="50,23,75,354" TextWrapping="Wrap" Text="Add Employee" Width="675" FontSize="24" FontFamily="Verdana" FontWeight="Bold" TextAlignment="Center"/>
		<StackPanel Width="650" Margin="101,196,49,31">
			<StackPanel Orientation="Horizontal" Height="25">
				<TextBlock x:Name="lblId" Text="ID" Width="280" FontSize="16"></TextBlock>
				<TextBox x:Name="txtId" Text="{Binding NewEmployee.Id, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" Width="300" FontSize="16"></TextBox>
				<TextBlock Text="*" Foreground="Red" Width="30" FontSize="20"></TextBlock>
			</StackPanel>
			<StackPanel Orientation="Horizontal" Height="25">
				<TextBlock x:Name="lblName" Text="Name" Width="280" FontSize="16"></TextBlock>
				<TextBox x:Name="txtName" Text="{Binding NewEmployee.Name, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" Width="300" FontSize="16"></TextBox>
				<TextBlock Text="*" Foreground="Red" Width="30" FontSize="20"></TextBlock>
			</StackPanel>
			<StackPanel Orientation="Horizontal" Height="25">
				<TextBlock x:Name="lblEmail" Text="Email" Width="280" FontSize="16"></TextBlock>
				<TextBox x:Name="txtEmail" Text="{Binding NewEmployee.Email, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" Width="300" FontSize="16"></TextBox>
				<TextBlock Text="*" Foreground="Red" Width="30" FontSize="20"></TextBlock>
			</StackPanel>
			<StackPanel Orientation="Horizontal" Height="25">
				<TextBlock x:Name="lblDesignation" Text="Designation" Width="280" FontSize="16"></TextBlock>
				<TextBox x:Name="txtDesignation" Text="{Binding NewEmployee.Designation, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" Width="300" FontSize="16"></TextBox>
				<TextBlock Text="*" Foreground="Red" Width="30" FontSize="20"></TextBlock>
			</StackPanel>
			<StackPanel Orientation="Horizontal" Height="25">
				<TextBlock Text="Address" Width="279" FontSize="16"></TextBlock>
				<TextBox Text="{Binding NewEmployee.Address, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" Width="300" FontSize="16"></TextBox>
			</StackPanel>
			<StackPanel Orientation="Horizontal" Height="25">
				<TextBlock x:Name="lblPhoneNumber" Text="Phone Number" Width="280" FontSize="16"></TextBlock>
				<TextBox x:Name="txtPhoneNumber" Text="{Binding NewEmployee.PhoneNumber, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" Width="300" FontSize="16"></TextBox>
			</StackPanel>
			<StackPanel Orientation="Horizontal" Height="25">
				<TextBlock x:Name="lblPicture" Text="Picture" Width="280" FontSize="16"></TextBlock>
				<TextBox x:Name="txtPicture" Text="{Binding NewEmployee.PhotoPath, UpdateSourceTrigger=PropertyChanged, ValidatesOnDataErrors=True}" Width="230" FontSize="16"></TextBox>
				<Button x:Name="btnLoadPicture" Content="Load pic..." Width="70" FontSize="14" Click="btnLoadPicture_Click"/>
			</StackPanel>
		</StackPanel>
		<StackPanel Orientation="Horizontal" Height="30" Margin="658,382,50,22">
			<Button x:Name="btnAdd" Content="Add" Width="71" FontSize="16" Command="{Binding CreateCommand}" IsEnabled="{Binding IsAddButtonEnabled}" Click="btnAdd_Click"/>
		</StackPanel>
		<Image x:Name="imgPicture" Source="{Binding NewEmployee.ProfileImage}" Height="113" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Margin="320,75,357,246" Width="123" />


	</Grid>
</Window>




<Window x:Class="EmployeeDatabaseApp.MainWindow" WindowState="Maximized"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:EmployeeDatabaseApp" xmlns:viewmodels="clr-namespace:EmployeeDatabaseApp.ViewModels" d:DataContext="{d:DesignInstance Type=viewmodels:EmployeeViewModel}"
		mc:Ignorable="d"
        Title="Employee Database" Height="450" Width="800">
	<Grid>
		<StackPanel Margin="0,0,0,413">
			<Menu VerticalAlignment="Top">
				<MenuItem x:Name="mnuFile" Header="_File">
					<MenuItem x:Name="mnuImport" Header="_Import"/>
					<MenuItem x:Name="mnuExport" Header="_Export"/>
					<Separator/>
					<MenuItem x:Name="mnuExit" Header="E_xit"/>
				</MenuItem>
			</Menu>
		</StackPanel>
		<StackPanel Margin="0,1,0,326">
			<TextBlock x:Name="lblEmployeeDatabase" Height="52" Margin="131,56,142,0" TextWrapping="Wrap" Text="Employee Database" VerticalAlignment="Top" Width="527" FontSize="24" FontFamily="Verdana" FontWeight="Bold" TextAlignment="Center"/>
		</StackPanel>
		<StackPanel Orientation="Horizontal" Margin="0,0,-11,217" VerticalAlignment="Center" HorizontalAlignment="Center" Height="211" Width="761">
			<Button x:Name="btnAdd" Height="30" Margin="588,174,0,0" VerticalAlignment="Top" Width="41" Click="btnAdd_Click">
				<Button.Background>
					<ImageBrush ImageSource="/8201370_add_plus_button_ui_new_icon.png"/>
				</Button.Background>
			</Button>
			<Button x:Name="btnDelete" Height="30" Margin="10,174,0,0" VerticalAlignment="Top" Width="41">
				<Button.Background>
					<ImageBrush ImageSource="/619539_close_delete_dismiss_exit_cancel_icon.png"/>
				</Button.Background>
			</Button>
			<Button x:Name="btnEdit" Height="30" Margin="10,174,0,0" VerticalAlignment="Top" Width="41" Click="btnEdit_Click">
				<Button.Background>
					<ImageBrush ImageSource="/11928482.png"/>
				</Button.Background>
			</Button>
		</StackPanel>

		<DataGrid x:Name="dgEmployeeList" Height="196" Margin="43,209,37,29" Width="720" ItemsSource="{Binding Employees}"  SelectedItem="{Binding SelectedEmployee, Mode=TwoWay}" IsReadOnly="True" SelectionMode="Single" 
                   AreRowDetailsFrozen="True" AutoGenerateColumns="False">
			<DataGrid.Columns>
				<DataGridTextColumn Header="Name" Width="*" Binding="{Binding Name}"/>
				<DataGridTextColumn Header="Email" Width="*" Binding="{Binding Email, Mode=TwoWay}"/>
				<DataGridTextColumn Header="Designation" Width="*" Binding="{Binding Designation, Mode=TwoWay}"/>

				<DataGridTextColumn Header="ID"  Width="*" Binding="{Binding Id, Mode=TwoWay}"/>
				<DataGridTemplateColumn Header="Picture" Width="*">
					<DataGridTemplateColumn.CellTemplate>
						<DataTemplate>
							<Image Source="{Binding ProfileImage, Mode=TwoWay}" Width="50" Height="50"/>
						</DataTemplate>
					</DataGridTemplateColumn.CellTemplate>
				</DataGridTemplateColumn>
				<DataGridTextColumn Header="Address" Width="*" Binding="{Binding Address, Mode=TwoWay}"/>
				<DataGridTextColumn Header="PhoneNumber" Binding="{Binding PhoneNumber, Mode=TwoWay}"/>
			</DataGrid.Columns>
		</DataGrid>
	</Grid>
</Window>
