using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;
using System.Net;
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media.Imaging;
using EmployeeDatabaseApp.Commands;
using EmployeeDatabaseApp.Dialogs;
using EmployeeDatabaseApp.Models;
using System.Windows.Controls;
using System.Globalization;
using Microsoft.Win32;
using System.Xml.Linq;
using System.IO;
using System.Xml;


namespace EmployeeDatabaseApp.ViewModels
{
	public delegate void DWindowClose();
	public class EmployeeViewModel : IDataErrorInfo, INotifyPropertyChanged
	{
		public DWindowClose AddEmployeeDialogClose;
		public DWindowClose EditEmployeeDialogClose;

		private string _id;
		private string _name;
		private string _email;
		private string _designation;
		private string _address;
		private string _photoPath;
		private string _phoneNumber;

		// Dictionary to hold Validation errors
		private readonly Dictionary<string, string> _errors = new Dictionary<string, string>();

		public string Id
		{
			get { return _id; }
			set
			{
				if (_id != value)
				{
					_id = value;
					ValidateProperty(nameof(Id));
					OnPropertyChanged(nameof(Id));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}
		public string Name
		{
			get { return _name; }
			set
			{
				if (_name != value)
				{
					_name = value;
					ValidateProperty(nameof(Name));
					OnPropertyChanged(nameof(Name));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}
		public string Email
		{
			get { return _email; }
			set
			{
				if (_email != value)
				{
					_email = value;
					ValidateProperty(nameof(Email));
					OnPropertyChanged(nameof(Email));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}

		public string Designation
		{
			get { return _designation; }
			set
			{
				if (_designation != value)
				{
					_designation = value;
					ValidateProperty(nameof(Designation));
					OnPropertyChanged(nameof(Designation));
					OnPropertyChanged(nameof(IsButtonEnabled));
				}
			}
		}
		public string Address
		{
			get { return _address; }
			set
			{
				_address = value;
				OnPropertyChanged("Address");
			}
		}
		public string PhotoPath
		{
			get { return _photoPath; }
			set
			{
				_photoPath = value;
				OnPropertyChanged("PhotoPath");
			}
		}
		public string PhoneNumber
		{
			get { return _phoneNumber; }
			set
			{
				_phoneNumber = value;
				ValidateProperty(nameof(PhoneNumber));
				OnPropertyChanged("PhoneNumber");
			}
		}


		private Employee _newEmployee;
		public Employee NewEmployee
		{
			get => _newEmployee;
			set { _newEmployee = value; OnPropertyChanged(nameof(NewEmployee)); }
		}
		private Employee _selectedEmployee;
		public Employee SelectedEmployee
		{
			get { return _selectedEmployee; }
			set
			{
				_selectedEmployee = value;
				OnPropertyChanged(nameof(SelectedEmployee));
			}
		}

		// Profile Image
		private BitmapImage _profileImage;
		public BitmapImage ProfileImage
		{
			get
			{
				return _profileImage;
			}
			set
			{
				_profileImage = value;
				OnPropertyChanged(nameof(ProfileImage));
			}
		}

		private string _selectedPhotoPath;
		public string SelectedPhotoPath
		{
			get { return _selectedPhotoPath; }
			set
			{
				_selectedPhotoPath = value;
				OnPropertyChanged(nameof(SelectedPhotoPath));

				// Update Bitmap whenever path changes
				ProfileImage = !string.IsNullOrEmpty(value) ? new BitmapImage(new Uri(value)) : null;
			}
		}

		private bool _isValid = false;
		public bool IsValid
		{
			get => _isValid;
			private set
			{
				if (_isValid != value)
				{
					_isValid = value;
					OnPropertyChanged(nameof(IsValid)); // Notify UI of validation state changes
				}
			}
		}

		private ObservableCollection<Employee> _employees = null;
		public ObservableCollection<Employee> Employees
		{
			get => _employees;
			set { _employees = value; OnPropertyChanged(nameof(Employees)); }
		}

		// CRUD Commands
		public ICommand CreateCommand { get; }
		public ICommand UpdateCommand { get; }
		public ICommand DeleteCommand { get; }

		// File commands
		public ICommand OpenFileCommand { get; }
		public ICommand SaveFileCommand { get; }
		public ICommand LoadPhotoCommand { get; }

		public EmployeeViewModel()
		{
			this.NewEmployee = new Employee
			{
				Id = "1",
				Name = "Keerthana",
				Email = "kj@gmail.com",
				Designation = "Software Developer",
				Address = "Ernakulam",
				PhoneNumber = "1234567890"
			};

			// Initialise Employee collection
			this.Employees = new ObservableCollection<Employee>
			{
				new Employee { Id = "1", Name = "Keerthana", Email = "kj@gmail.com", Designation = "Software Developer", Address = "Ernakulam", PhoneNumber = "1234567890", PhotoPath=new Uri(photoAbsolutePath) },
				new Employee { Id = "2", Name = "Keerthana", Email = "kj@gmail.com", Designation = "Software Developer", Address = "Ernakulam", PhoneNumber = "1234567890", PhotoPath=@"C:\Users\2021454\Downloads\Obama" }
			};

			CreateCommand = new RelayCommand(Create);
			UpdateCommand = new RelayCommand(Update);
			DeleteCommand = new RelayCommand(Delete);

			// Initialise with a new Employee object
			NewEmployee = new Employee();

			OpenFileCommand = new RelayCommand(OpenFile);
			SaveFileCommand = new RelayCommand(SaveFile);

			// Load Profile Picture
			LoadPhotoCommand = new RelayCommand(LoadPhoto);
		}

		public void Create()
		{
			// ID increment logic (can be implemented)
			string id = (Employees.Count + 1).ToString();

			// Allow user to pick a photo
			string selectedPhotoPath = LoadPhoto();

			Employee newEmployee = new Employee
			{
				Id = NewEmployee.Id,
				Name = NewEmployee.Name,
				Email = NewEmployee.Email,
				PhoneNumber = NewEmployee.PhoneNumber,
				Address = NewEmployee.Address,
				Designation = NewEmployee.Designation,
				ProfileImage = NewEmployee.ProfileImage,
				PhotoPath =	new Uri(photoAbsolutePath)	//NewEmployee.PhotoPath,
			};
			var result = MessageBox.Show(messageBoxText: "Are you sure to create?",
					caption: "Confirm",
					button: MessageBoxButton.YesNo,
					icon: MessageBoxImage.Question);
			if (result != MessageBoxResult.Yes)
			{
				return;
			}
			Employees.Add(newEmployee);
			//NewEmployee = new Employee();
			
			result = MessageBox.Show(messageBoxText: "Created Successfully",
					caption: "Alert",
					button: MessageBoxButton.OK,
					icon: MessageBoxImage.Information);
			if (result == MessageBoxResult.OK)
			{
				// Close the window
				WindowConfig.addEmployeeDialog.Close();
			}

			this.NewEmployee = new Employee
			{
				Id = "0",
				Name = " ",
				Email = " ",
				Designation = " ",
				Address = " ",
				PhoneNumber = " ",
				PhotoPath= new Uri(photoAbsolutePath)
			};


		}
		public void Update()
		{
			if (this.SelectedEmployee == null)
			{
				return;
			}
			this.SelectedEmployee = this.SelectedEmployee;
			var result = MessageBox.Show(messageBoxText: "Updated Successfully",
					caption: "Alert",
					button: MessageBoxButton.OK,
					icon: MessageBoxImage.Information);
			if (result == MessageBoxResult.OK)
			{
				// Close the window
				WindowConfig.editEmployeeDialog.Close();
			}
		}

		public void Delete()
		{
			
			if (SelectedEmployee == null)
			{
				var result = MessageBox.Show(messageBoxText: "Please select an employee to delete",
					caption: "Alert",
					button: MessageBoxButton.OK,
					icon: MessageBoxImage.Information);
				return;
			}
			if (SelectedEmployee != null)
			{
				var employeeCount = Employees.Count();
				var result = MessageBox.Show(messageBoxText: "Are you sure to delete?",
					caption: "Warning",
					button: MessageBoxButton.YesNo,
					icon: MessageBoxImage.Information);
				if (result != MessageBoxResult.Yes)
				{
					return;
				}
				else
				{
					Employees.Remove(SelectedEmployee);
					if(Employees.Count() == employeeCount - 1)
					result = MessageBox.Show(messageBoxText: "Deleted",
						caption: "Alert",
						button: MessageBoxButton.OK,
						icon: MessageBoxImage.Information);
					SelectedEmployee = null;

				}
			}
		}

		
		// Property to control Add button
		// Enabled if no error exists
		//public bool IsButtonEnabled => !_errors.Any();

		// Centralized validation method
		public void ValidateProperty(string propertyName)
		{
			string error = string.Empty;
			switch (propertyName)
			{
				case nameof(Id):
					error = string.IsNullOrEmpty(Id) ? "ID is required" : null;
					break;
				case nameof(Name):
					error = string.IsNullOrEmpty(Name) ? "Name is required" : null;
					break;
				case nameof(Email):
					if (string.IsNullOrEmpty(Email))
					{
						error = "Email is required";
					}
					else if (!IsValidEmail(Email))
					{
						error = "Invalid email format";
					}
					break;
				case nameof(Designation):
					error = string.IsNullOrEmpty(Designation) ? "Designation is required" : null;
					break;
				case nameof(PhoneNumber):
					if (string.IsNullOrEmpty(PhoneNumber))
					{
						error = "Phone Number is required";
					}
					else if (!IsValidPhoneNumber(PhoneNumber))
					{
						error = "Phone Number must be 10 digits ";
					}
					break;
			}

			if (error != null)
			{
				_errors[propertyName] = error;
			}
			else
			{
				_errors.Remove(propertyName);
			}

			// Update the overall validation state
			IsValid = _errors.Count == 0;

			// Notify UI of error changes
			OnPropertyChanged(nameof(Error));
		}

		// Method to validate email format
		private bool IsValidEmail(string email)
		{
			string emailPattern = @"^[^@\s]+@[^@\s]+\.[^@\s]+$";
			return Regex.IsMatch(email, emailPattern);
		}

		// Method to validate phone number format
		private bool IsValidPhoneNumber(string phoneNumber)
		{
			string phonePattern = @"^\d{10}$";
			return Regex.IsMatch(phoneNumber, phonePattern);
		}

		public string Error => _errors.Any() ? "Please fix the errors" : null;

		// Button enabling condition
		public bool IsButtonEnabled => string.IsNullOrEmpty(this[nameof(Email)]) && string.IsNullOrEmpty(this[nameof(PhoneNumber)])
			&& string.IsNullOrEmpty(this[nameof(Id)]) && string.IsNullOrEmpty(this[nameof(Designation)]);

		public string this[string columnName] => _errors.ContainsKey(columnName) ? _errors[columnName] : null;

		// Property changed notification
		public event PropertyChangedEventHandler PropertyChanged;
		protected void OnPropertyChanged(string propertyName)
		{
			PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
		}

		// Method to load the image (after file selection)
		public void LoadPhoto()
		{
			// Filter to allow only Image files
			OpenFileDialog openFileDialog = new OpenFileDialog
			{
				Filter = "Image files (*.jpg;*.jpeg;*.png)|*.jpg;*.jpeg;*.png|All files (*.*)|*.*",
				Title = "Select a Photo"
			};
			// Show the dialog and check if the user selected a file
			if (openFileDialog.ShowDialog() == true)
			{
				//BitmapImage bitmap = new BitmapImage(new Uri(openFileDialog.FileName)); ////////////////////////
				PhotoPath=openFileDialog.FileName; //Store the selected photo path
				ProfileImage = new BitmapImage(new Uri(PhotoPath));
				SelectedEmployee.ProfileImage = new BitmapImage(new Uri(PhotoPath));
			}
		}

		//Method to save selected photo to designated folder
		public void SavePhotoForEmployee(string sourcePhotoPath, int Id)
		{
			string destinationFolder = @"C:\Users\2021454\source\repos\EmployeeDatabaseApp\EmployeeDatabaseApp\ProfilePictures\";
			if (!Directory.Exists(destinationFolder))
			{
				Directory.CreateDirectory(destinationFolder);
			}
			// Unique destination path for employee photo
			string destinationPhotoPath = Path.Combine(destinationFolder, $"employee_{Id}.jpg");

			// Copy file to destination folder
			File.Copy(sourcePhotoPath,destinationPhotoPath,true) //true to overwrite if it exists
		}

		// File
		private void OpenFile()
		{
			OpenFileDialog openFileDialog = new OpenFileDialog
			{
				Filter = "XML files (*.xml)|*.xml|All files (*.*)|*.*"
			};

			if (openFileDialog.ShowDialog() == true)
			{
				string filePath = openFileDialog.FileName;
				if (IsValidXmlFile(filePath, out string errorMessage))
				{
					// Proceed with importing the XML file
					LoadEmployees(filePath);
				}
				else
				{
					// Show an error message if the file is invalid
					MessageBox.Show(errorMessage, "Invalid File", MessageBoxButton.OK, MessageBoxImage.Error);
				}
			}
		}
		private void SaveFile()
		{
			SaveFileDialog saveFileDialog = new SaveFileDialog
			{
				Filter = "XML files (*.xml)|*.xml|All files (*.*)|*.*",
				DefaultExt = "xml"
			};

			if (saveFileDialog.ShowDialog() == true)
			{
				string filePath = saveFileDialog.FileName;
				SaveEmployees(filePath);
			}
		}

		private void SaveEmployees(string filePath)
		{
			try
			{
				XDocument xmlDoc = new XDocument(
					new XElement("AddEmployee",
						from employee in Employees
						select new XElement("Employee",
							new XElement("ID", employee.Id),
							new XElement("Name", employee.Name),
							new XElement("Email", employee.Email),
							new XElement("Designation", employee.Designation),
							new XElement("PhoneNumber", employee.PhoneNumber),
							new XElement("PhotoPath", employee.PhotoPath),
							new XElement("Address", employee.Address)

						)
					)
				);

				xmlDoc.Save(filePath);
			}
			catch(Exception ex)
			{
				MessageBox.Show($"Error saving employees in XML file: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
			}
		}

		private void LoadEmployees(string filePath)
		{
			try
			{
				//Clear existing data in grid
				Employees.Clear();
				XDocument xmlDoc = XDocument.Load(filePath);
				var employees = xmlDoc.Descendants("Employee");

				foreach (var employee in employees)
				{
					Employees.Add(new Employee
					{
						Id = employee.Element("ID")?.Value,
						Name = employee.Element("Name")?.Value,
						Email = employee.Element("Email")?.Value,
						Designation = employee.Element("Designation")?.Value,
						PhoneNumber = employee.Element("PhoneNumber")?.Value,
						Address = employee.Element("Address")?.Value,
						PhotoPath = employee.Element("PhotoPath")?.Value,
					});
				}
			}
			catch (Exception ex)
			{
				MessageBox.Show($"Error loading employees in XML file: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
			}
		}
		private bool IsValidXmlFile(string filePath, out string errorMessage)
		{
			errorMessage = string.Empty;
			try
			{
				// Try to load the XML file
				XmlDocument xmlDoc = new XmlDocument();
				xmlDoc.Load(filePath);
				return true;
			}
			catch (XmlException)
			{
				// If an XmlException occurs, the file is not a valid XML file
				errorMessage = "Invalid XML file";
				return false;
			}
			catch (FileNotFoundException)
			{
				// If a FileNotFoundException occurs, the file does not exist
				errorMessage = "The selected file was not found.";
				return false;
			}
			catch (Exception ex)
			{
				// Catch any other exceptions and return false
				errorMessage = "An unexpected error occurred: " + ex.Message;
				return false;
			}
		}

	}
}
